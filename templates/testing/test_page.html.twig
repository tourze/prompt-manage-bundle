{% extends '@EasyAdmin/layout.html.twig' %}

{% block title %}æç¤ºè¯æµ‹è¯• - {{ prompt_name }}{% endblock %}

{% block page_title %}ğŸ§ª æç¤ºè¯æµ‹è¯• - {{ prompt_name }} (v{{ version }}){% endblock %}

{% block main %}
<div class="container-fluid">
    <div class="row">
        <!-- å·¦ä¾§ï¼šæ¨¡æ¿å’Œå‚æ•° -->
        <div class="col-md-6">
            <div class="card mb-3">
                <div class="card-header">
                    <h5>ğŸ“ æ¨¡æ¿å†…å®¹</h5>
                </div>
                <div class="card-body">
                    <pre class="bg-light p-3 border rounded" style="white-space: pre-wrap; max-height: 200px; overflow-y: auto;">{{ template }}</pre>
                </div>
            </div>

            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5>âš™ï¸ å‚æ•°è®¾ç½®</h5>
                    <button type="button" class="btn btn-outline-secondary btn-sm" id="clearParameters">
                        ğŸ—‘ï¸ æ¸…ç©ºå‚æ•°
                    </button>
                </div>
                <div class="card-body">
                    <form id="testForm" method="post" action="{{ path('prompt_test_execute', {promptId: prompt_id, version: version}) }}">
                        {% if parameters is empty %}
                            <div class="alert alert-info">
                                ğŸ‰ æ­¤æ¨¡æ¿æ— éœ€å‚æ•°ï¼Œå¯ç›´æ¥æ‰§è¡Œæµ‹è¯•
                            </div>
                        {% else %}
                            <div id="parametersContainer">
                                {% for param_name, param_info in parameters %}
                                    <div class="mb-3">
                                        <label for="param_{{ param_name }}" class="form-label">
                                            {{ param_name }}
                                            {% if param_info.required|default(true) %}
                                                <span class="text-danger">*</span>
                                            {% endif %}
                                        </label>
                                        {% if param_info.type|default('string') == 'textarea' %}
                                            <textarea
                                                class="form-control"
                                                id="param_{{ param_name }}"
                                                name="parameters[{{ param_name }}]"
                                                rows="3"
                                                {% if param_info.required|default(true) %}required{% endif %}
                                            >{{ parameter_values[param_name]|default('') }}</textarea>
                                        {% else %}
                                            <input
                                                type="text"
                                                class="form-control"
                                                id="param_{{ param_name }}"
                                                name="parameters[{{ param_name }}]"
                                                value="{{ parameter_values[param_name]|default('') }}"
                                                {% if param_info.required|default(true) %}required{% endif %}
                                            />
                                        {% endif %}
                                        {% if param_info.description|default('') %}
                                            <small class="form-text text-muted">{{ param_info.description }}</small>
                                        {% endif %}
                                    </div>
                                {% endfor %}
                            </div>
                        {% endif %}

                        <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-3">
                            <button type="submit" class="btn btn-primary" id="executeButton">
                                <span id="buttonText">ğŸš€ æ‰§è¡Œæµ‹è¯•</span>
                                <span id="buttonSpinner" class="spinner-border spinner-border-sm ms-2" style="display: none;"></span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- å³ä¾§ï¼šæµ‹è¯•ç»“æœ -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5>ğŸ“Š æµ‹è¯•ç»“æœ</h5>
                </div>
                <div class="card-body">
                    <div id="resultContainer">
                        {% if test_result is defined %}
                            {% if test_result.success %}
                                <div class="alert alert-success">
                                    <h6>âœ… æµ‹è¯•æˆåŠŸ</h6>
                                    {% if test_result.metadata.parameter_warnings|default([]) is not empty %}
                                        <div class="mt-2">
                                            <small class="text-warning">
                                                âš ï¸ è­¦å‘Š: {{ test_result.metadata.parameter_warnings|join(', ') }}
                                            </small>
                                        </div>
                                    {% endif %}
                                </div>
                                <div class="mt-3">
                                    <h6>æ¸²æŸ“ç»“æœï¼š</h6>
                                    <div class="border rounded p-3 bg-light" style="white-space: pre-wrap; max-height: 400px; overflow-y: auto;">{{ test_result.content }}</div>
                                </div>
                                {% if test_result.metadata %}
                                    <details class="mt-3">
                                        <summary class="btn btn-outline-info btn-sm">ğŸ” å…ƒæ•°æ®</summary>
                                        <pre class="mt-2 bg-light p-2 border rounded small">{{ test_result.metadata|json_encode(constant('JSON_PRETTY_PRINT')) }}</pre>
                                    </details>
                                {% endif %}
                            {% else %}
                                <div class="alert alert-danger">
                                    <h6>âŒ æµ‹è¯•å¤±è´¥</h6>
                                    <p><strong>é”™è¯¯ä¿¡æ¯ï¼š</strong>{{ test_result.error|default('æœªçŸ¥é”™è¯¯') }}</p>
                                    {% if test_result.content %}
                                        <details class="mt-2">
                                            <summary>æŸ¥çœ‹éƒ¨åˆ†æ¸²æŸ“å†…å®¹</summary>
                                            <pre class="mt-2 bg-light p-2 border rounded">{{ test_result.content }}</pre>
                                        </details>
                                    {% endif %}
                                </div>
                            {% endif %}
                        {% else %}
                            <div class="text-center text-muted py-5" id="initialState">
                                <i class="fa fa-flask fa-3x mb-3"></i>
                                <p>ç‚¹å‡»"æ‰§è¡Œæµ‹è¯•"æŒ‰é’®å¼€å§‹æµ‹è¯•</p>
                                <small>ç³»ç»Ÿå°†ä½¿ç”¨æ‚¨æä¾›çš„å‚æ•°æ¸²æŸ“æ¨¡æ¿</small>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- è¿”å›æŒ‰é’® -->
    <div class="row mt-3">
        <div class="col-12">
            <a href="{{ path('admin') }}" class="btn btn-outline-secondary">
                â† è¿”å›ç®¡ç†é¢æ¿
            </a>
        </div>
    </div>
</div>

<style>
    .test-page-state-loading {
        opacity: 0.6;
        pointer-events: none;
    }

    .test-page-state-success .alert-success {
        animation: fadeIn 0.5s ease-in;
    }

    .test-page-state-error .alert-danger {
        animation: shake 0.5s ease-in-out;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    @keyframes shake {
        0%, 100% { transform: translateX(0); }
        25% { transform: translateX(-5px); }
        75% { transform: translateX(5px); }
    }
</style>

<script>
/**
 * æç¤ºè¯æµ‹è¯•é¡µé¢ JavaScript
 * Linus: "ç®€å•èƒœäºå¤æ‚" - åªæœ‰5ä¸ªçŠ¶æ€ï¼Œå¯é¢„æµ‹
 */
(function() {
    'use strict';

    // çŠ¶æ€å®šä¹‰ï¼ˆFRDè¦æ±‚çš„5ä¸ªçŠ¶æ€ï¼‰
    const TestPageState = {
        INITIAL: 'initial',
        LOADING: 'loading',
        SUCCESS: 'success',
        ERROR: 'error',
        CLEARED: 'cleared'
    };

    let currentState = TestPageState.INITIAL;

    // DOM å…ƒç´ 
    const form = document.getElementById('testForm');
    const executeButton = document.getElementById('executeButton');
    const buttonText = document.getElementById('buttonText');
    const buttonSpinner = document.getElementById('buttonSpinner');
    const clearButton = document.getElementById('clearParameters');
    const resultContainer = document.getElementById('resultContainer');
    const initialState = document.getElementById('initialState');

    // çŠ¶æ€ç®¡ç†
    function setState(newState) {
        // æ¸…é™¤ä¹‹å‰çš„çŠ¶æ€ç±»
        document.body.classList.remove(`test-page-state-${currentState}`);

        currentState = newState;

        // æ·»åŠ æ–°çŠ¶æ€ç±»
        document.body.classList.add(`test-page-state-${currentState}`);

        // æ ¹æ®çŠ¶æ€æ›´æ–°UI
        switch (newState) {
            case TestPageState.LOADING:
                executeButton.disabled = true;
                buttonText.textContent = 'â³ æ‰§è¡Œä¸­...';
                buttonSpinner.style.display = 'inline-block';
                break;

            case TestPageState.SUCCESS:
            case TestPageState.ERROR:
                executeButton.disabled = false;
                buttonText.textContent = 'ğŸš€ æ‰§è¡Œæµ‹è¯•';
                buttonSpinner.style.display = 'none';
                break;

            case TestPageState.CLEARED:
            case TestPageState.INITIAL:
                executeButton.disabled = false;
                buttonText.textContent = 'ğŸš€ æ‰§è¡Œæµ‹è¯•';
                buttonSpinner.style.display = 'none';
                break;
        }
    }

    // è¡¨å•æäº¤å¤„ç†
    if (form) {
        form.addEventListener('submit', function(e) {
            setState(TestPageState.LOADING);
        });
    }

    // æ¸…ç©ºå‚æ•°æŒ‰é’®
    if (clearButton) {
        clearButton.addEventListener('click', function() {
            const inputs = form.querySelectorAll('input[type="text"], textarea');
            inputs.forEach(input => input.value = '');
            setState(TestPageState.CLEARED);

            // å¦‚æœæœ‰åˆå§‹çŠ¶æ€æç¤ºï¼Œæ˜¾ç¤ºå®ƒ
            if (initialState) {
                resultContainer.innerHTML = initialState.outerHTML;
            }
        });
    }

    // æ£€æµ‹å½“å‰é¡µé¢çŠ¶æ€
    {% if test_result is defined %}
        {% if test_result.success %}
            setState(TestPageState.SUCCESS);
        {% else %}
            setState(TestPageState.ERROR);
        {% endif %}
    {% else %}
        setState(TestPageState.INITIAL);
    {% endif %}

    // å®æ—¶å‚æ•°éªŒè¯ï¼ˆå¯é€‰å¢å¼ºï¼‰
    const paramInputs = form?.querySelectorAll('input[required], textarea[required]');
    if (paramInputs) {
        paramInputs.forEach(input => {
            input.addEventListener('input', function() {
                this.classList.toggle('is-valid', this.value.trim() !== '');
                this.classList.toggle('is-invalid', this.value.trim() === '');
            });
        });
    }
})();
</script>
{% endblock %}