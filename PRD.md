# AI 提示词管理模块（Symfony Bundle）产品需求文档
**文档版本**：V1.0  
**编写日期**：2024年X月X日  
**适用范围**：Symfony 5.4+ 框架下的 AI 提示词集中管理需求


## 1. 产品背景与目标
### 1.1 背景与痛点
近年来，AI 应用中提示词（Prompt）的使用场景（对话式 AI、内容生成、客户服务等）和数量快速增长，但缺乏标准化管理机制导致以下核心痛点（参考行业实践）：
- **存储混乱**：提示词散落在代码、文档或个人笔记中，无法共享和统一检索；
- **版本不可控**：多角色修改后无历史记录，无法追溯“何时、何人、做了何种变更”；
- **协同低效**：产品、开发、运营多角色协作时，重复劳动多、沟通成本高；
- **优化困难**：缺乏统一平台对比不同版本效果，无法快速验证优化方向；
- **安全隐患**：含机密信息的提示词（如系统指令）管理不当，存在泄露风险。


### 1.2 产品目标
构建一个 **可复用的 Symfony Bundle**，实现 AI 提示词的全生命周期管理，核心目标如下：
1. **高效管理**：支持提示词的创建、编辑、分类，降低多角色协作成本；
2. **版本可控**：提供完整的版本记录、对比、回滚能力，追溯变更历史；
3. **便捷验证**：内置测试功能，无需脱离后台即可验证提示词效果；
4. **安全合规**：通过权限控制和操作日志，保障敏感提示词安全；
5. **开发友好**：提供标准化服务接口，支持开发者在代码中快速调用，实现“提示词与代码解耦”。


## 2. 用户角色与核心需求
| 角色                | 核心职责                                  | 核心需求                                                                 |
|---------------------|-------------------------------------------|--------------------------------------------------------------------------|
| 开发者/提示词工程师 | 集成提示词到代码、优化提示词逻辑          | 1. 提供标准化服务接口获取提示词；2. 版本稳定，避免随意修改破坏功能；3. 可追溯变更历史 |
| 运营/产品经理       | 维护提示词内容、验证效果（无需改代码）    | 1. 可视化界面增删改提示词；2. 按项目/标签分类管理；3. 即时测试提示效果；4. 权限隔离 |
| 系统管理员          | 部署模块、配置权限、保障数据安全          | 1. 支持角色权限分配；2. 数据备份与加密；3. 易集成到现有 Symfony 系统（如SSO）     |
| 测试/审核人员（潜在）| 验证提示词效果、审计合规性                | 1. 只读查看提示词及版本；2. 对比不同版本效果；3. 查看操作日志                  |


## 3. 功能规格（按优先级划分）
### 3.1 核心功能（P0：一期必实现）
#### 3.1.1 提示词基础管理（CRUD）
- **创建**：填写名称、所属项目、标签、内容模板，生成初始版本（v1）；
- **编辑**：修改内容后生成新版本（不覆盖历史），需填写“变更备注”说明修改目的；
- **删除**：默认支持**软删除**（Prompt 表新增 `deleted_at` 字段，UI 隐藏已删除数据，管理员可查看）；
- **查询**：列表页展示关键信息（名称、项目、标签、当前版本、最后修改时间），支持按名称/内容关键词搜索。
- **模板支持**：内容允许包含变量占位符（如 `{user_input}` `{context}`），支持 Jinja2 风格语法（可选代码高亮）。

### 3.2 附加功能（二期）
- 批量操作：导出/导入
- 收藏功能：常用提示词标记  
- AI API对接：直接测试

#### 3.1.3 版本控制
- **版本生成**：每次编辑保存自动生成新版本，版本号规则为“整数递增”（v1→v2→v3...，初始版本为v1）；
- **版本切换**：选择历史版本后，系统自动复制该版本内容生成**新版本**（如从v2切换回v1，生成v3，内容与v1一致），避免版本链断裂；
- **版本对比**：选择两个版本，高亮展示差异（红色标删除内容、绿色标新增内容）；
- **版本记录**：详情页展示所有版本（版本号、修改人、修改时间、变更备注），支持点击查看对应版本内容。

#### 3.1.4 测试功能
- **核心逻辑**：初始版本实现 **方案A（仅预览组装结果）**，二期扩展方案B（对接AI API）；
- **操作流程**：
    1. 选择提示词及版本，系统自动解析模板中的占位符（如 `{user_input}`），生成对应输入框；
    2. 用户输入参数后，点击“执行测试”，展示**组装后的完整提示词文本**（如模板“你好{name}”+参数name=“张三”→“你好张三”）；
    3. 支持多次修改参数重新测试，对比不同参数下的组装结果。

#### 3.1.5 操作日志与审计
- **日志内容**：记录所有关键操作（新增/编辑/删除提示词、版本切换），包含“操作人、操作时间、操作类型、关联提示词ID/版本”；
- **日志查看**：仅管理员可查看完整日志，支持按时间范围、操作人筛选；
- **日志不可篡改**：日志数据仅新增，不允许修改/删除，满足审计合规要求。


### 3.2 辅助功能（P1：一期可选，二期必实现）
- **批量操作**：支持批量导出提示词（JSON/YAML 格式，包含当前版本内容）、批量删除（仅软删除）；
- **收藏标记**：支持运营人员标记“常用提示词”，列表页优先展示收藏项；
- **提示词引用**：支持模板嵌套（如 Prompt A 引用 Prompt B 的内容），需检测循环依赖（如 A→B→A 提示报错）。


### 3.3 扩展功能（P2：二期后迭代）
- **AI API 对接**：实现测试功能的方案B，支持配置 OpenAI/Anthropic 等 API Key，直接在测试页获取模型输出；
- **项目级权限**：细化权限到“项目维度”（如运营A仅能操作“客服Bot”项目的提示词，无法查看“营销文案”项目）；
- **使用统计**：统计提示词的调用次数、最近使用时间，辅助清理闲置提示词。


## 4. 界面设计（基于 EasyAdminBundle）
### 4.1 核心页面与交互
#### 4.1.1 提示词列表页
- **布局**：左侧导航菜单（“提示词管理”“项目管理”），右侧表格列表；
- **表格列**：名称、所属项目、标签（逗号分隔）、当前版本、最后修改时间、操作；
- **筛选控件**：顶部提供“项目下拉筛选”“标签云筛选”“关键词搜索框”；
- **操作按钮**：
    - 常规操作：查看/编辑、测试、删除（软删除，需二次确认）；
    - 批量操作：勾选多条后可“批量导出”“批量删除”（P1功能）；
    - 新增按钮：右上角“新增提示词”，跳转至创建页。

#### 4.1.2 提示词创建/编辑页
- **表单字段**：
    - 基本信息：名称（必填，≤100字符）、所属项目（下拉选择，必填）、标签（输入框，支持多选/新增）；
    - 内容模板：多行文本框（或富文本编辑器），支持代码高亮（Jinja2 语法）；
    - 变更备注：仅编辑时显示（必填，≤500字符，说明修改目的）；
- **交互提示**：编辑时顶部提示“本次修改将生成新版本，历史版本可追溯”。

#### 4.1.3 提示词详情/版本管理页
- **左侧区域**：展示当前版本信息（内容、版本号、修改人、修改时间、变更备注）；
- **右侧区域**：版本历史列表（按时间倒序），每条版本提供“查看内容”“对比版本”“切换为当前版本”按钮；
- **版本对比**：点击“对比版本”，弹出对话框选择另一个版本，高亮展示文本差异（红删绿增）。

#### 4.1.4 测试页
- **页面结构**：
    - 顶部：提示词名称+当前测试版本（下拉可切换版本）；
    - 中间：参数输入区（自动解析模板占位符生成输入框，如 `{user_input}` 对应“用户输入”输入框）；
    - 底部：“执行测试”按钮 + 结果展示区（展示组装后的完整提示词文本）；
- **交互**：输入参数后点击按钮，结果区实时刷新，支持清空参数重新测试。

#### 4.1.5 项目管理页
- **布局**：EasyAdmin 标准 CRUD 界面，表格列包含“项目名称”“描述”“提示词数量”“操作”；
- **操作**：支持新增（名称+描述）、编辑、删除（需确认：删除后关联提示词归为“默认项目”）。


### 4.2 权限适配
- **管理员（ROLE_PROMPT_ADMIN）**：可见所有页面和操作（包括日志查看、批量删除）；
- **编辑者（ROLE_PROMPT_EDITOR）**：可见列表、创建/编辑、测试页，不可见日志和项目删除；
- **只读者（ROLE_PROMPT_VIEWER）**：仅可见列表、详情页、测试页，无编辑/删除权限（按钮灰化）。


## 5. 数据模型（简化设计）
### 5.1 核心实体（贫血模型）
#### 5.1.1 Prompt（提示词主表）
| 字段名      | 类型         | 说明                     |
|-------------|--------------|----------------------------|
| id          | INT          | 主键                       |
| name        | VARCHAR(100) | 名称，非空                 |
| project_id  | INT          | 关联Project，可为null    |
| current_version | INT      | 当前版本号               |
| created_by  | INT          | 创建人 ID                |
| created_at  | DATETIME     | 创建时间                   |
| updated_at  | DATETIME     | 更新时间                   |

#### 5.1.2 PromptVersion（版本表）
| 字段名        | 类型         | 说明                      |
|--------------|--------------|-----------------------------|
| id           | INT          | 主键                        |
| prompt_id    | INT          | 关联Prompt                  |
| version      | INT          | 版本号（从1开始）           |
| content      | TEXT         | 内容模板                    |
| change_note  | VARCHAR(255) | 变更说明                    |
| created_by   | INT          | 创建人                      |
| created_at   | DATETIME     | 创建时间                    |
| 唯一约束     | (prompt_id, version) | 避免版本号重复 |

#### 5.1.3 Project（项目表）  
| 字段名     | 类型        | 说明        |
|-----------|-------------|-------------|
| id        | INT         | 主键          |
| name      | VARCHAR(50) | 名称，唯一   |
| created_at| DATETIME    | 创建时间      |

#### 5.1.4 Tag（标签表）
| 字段名 | 类型        | 说明      |
|-------|-------------|----------|
| id    | INT         | 主键        |
| name  | VARCHAR(30) | 标签名    |

#### 5.1.5 关联表
```sql
CREATE TABLE prompt_tags (
    prompt_id INT NOT NULL,
    tag_id INT NOT NULL,
    PRIMARY KEY (prompt_id, tag_id)
);
```


### 5.2 关系设计（简化）
- Prompt 1:N PromptVersion
- Prompt N:1 Project (可选)
- Prompt M:N Tag (多对多)


## 6. 技术架构（遵循仓库架构红线）
### 6.1 Bundle结构（简化设计）
```
PromptManageBundle
├── Entity/
│   ├── Prompt.php              # 贫血实体
│   ├── PromptVersion.php       # 贫血实体 
│   ├── Project.php             # 贫血实体
│   └── Tag.php                 # 贫血实体
├── Repository/
│   ├── PromptRepository.php    # 纯数据访问
│   └── PromptVersionRepository.php
├── Service/
│   └── PromptService.php       # 业务逻辑集中
├── Controller/
│   └── Admin/                  # EasyAdmin控制器
└── PromptManageBundle.php      # Bundle入口
```


### 6.2 核心服务：PromptService（业务逻辑集中）
单一服务类，所有业务逻辑集中：

| 方法名           | 参数                    | 返回            | 功能       |
|----------------|--------------------------|-----------------|-------------|
| getContent     | string $name             | string          | 获取提示词内容 |
| createPrompt   | string $name, $content   | Prompt          | 创建提示词   |
| updatePrompt   | int $id, string $content | PromptVersion   | 更新并生成版本 |
| switchVersion  | int $id, int $version    | bool            | 切换版本     |
| renderTemplate | string $template, array $params | string   | 模板渲染     |


### 6.3 集成方式（遵循架构红线）
#### 6.3.1 配置设计
- **禁止Configuration类**：配置直接从 `$_ENV` 读取，有默认值
- **环境变量**：
  ```bash
  PROMPT_ENABLE_AI_TEST=false
  PROMPT_DEFAULT_MODEL=gpt-3.5-turbo
  ```

#### 6.3.2 Bundle依赖
```php
// PromptManageBundle::getBundleDependencies()
return ['all' => true];  // 默认策略
```

#### 6.3.3 使用示例
```php
// 简单直接的服务调用
public function __construct(private PromptService $promptService) {}

$content = $this->promptService->getPromptContent('客服问候语');
$final = str_replace('{user_name}', $userName, $content);
```


## 7. 权限设计（简化）
### 7.1 角色权限
| 角色        | 权限                  |
|------------|----------------------|
| ADMIN      | 全部功能               |
| EDITOR     | 编辑提示词，无删除      |
| VIEWER     | 仅查看                |

### 7.2 权限实现
- Symfony Security注解: `@IsGranted("ROLE_PROMPT_ADMIN")`
- EasyAdmin配置: 角色限制  
- 服务层校验: 关键操作权限检查


### 7.3 数据安全
- HTTPS强制
- API Key使用Symfony Secrets
- 数据库备份

## 8. 技术要求
### 8.1 性能目标
- 查询响应: < 100ms
- 列表加载: < 200ms  
- 并发调用: 100+/秒

### 8.2 技术约束
- Symfony 5.4+
- MySQL 8.0+ / PostgreSQL 13+
- PHP 8.1+


## 9. 开发计划
| 阶段  | 周期 | 内容                    |
|------|-----|-------------------------|
| MVP  | 1周  | 核心CRUD + 版本管理      |
| v1.0 | 1周  | EasyAdmin界面 + 权限   |
| v2.0 | 1周  | 附加功能 + 优化       |


