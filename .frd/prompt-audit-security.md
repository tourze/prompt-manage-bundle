# FRD: 提示词审计日志与权限系统

## 📊 快速概览
| 项目 | 信息 |
|---|---|
| **ID** | `prompt-manage-bundle:prompt-audit-security@v1.0` |
| **类型** | `Package` |
| **阶段** | `🔵需求` → `🟢设计` → `🟡任务` → `🔴实施` → `✅验证` |
| **进度** | `████░░░░░░ 40%` |
| **创建** | `2025-09-04` |
| **更新** | `2025-09-04` |

---

## 1️⃣ 需求定义 [状态: ✅完成]

### 1.1. 核心问题与价值
解决提示词管理的安全隐患和合规要求，提供完整的操作审计、权限控制和安全保障，确保敏感提示词的安全管理和变更可追溯。

### 1.2. EARS 需求列表

#### 功能性需求 - 操作日志（韧性增强）
- **E1 (事件驱动)**: 当用户执行关键操作时，系统必须自动记录操作日志（新增/编辑/删除提示词、版本切换）
- **U1 (普遍性)**: 系统必须记录操作人、操作时间、操作类型、关联提示词ID/版本、IP地址、User-Agent等完整信息
- **U2 (普遍性)**: 系统必须支持仅管理员查看完整操作日志
- **U3 (普遍性)**: 系统必须支持按时间范围、操作人、IP地址、操作类型进行多维度日志筛选
- **S1 (状态驱动)**: 当用户为管理员角色时，系统必须显示日志查看菜单
- **C1 (条件性)**: 如果用户非管理员角色，那么系统必须隐藏所有日志相关功能
- **E3 (事件驱动)**: 当日志记录失败时，系统必须有降级方案（如本地文件记录），但不能阻塞主业务流程
- **U13 (普遍性)**: 系统必须支持日志的分级记录（ERROR/WARN/INFO），并支持按级别筛选

#### 功能性需求 - 权限控制（扩展性设计）
- **U4 (普遍性)**: 系统必须支持三种核心角色：管理员(ROLE_PROMPT_ADMIN)、编辑者(ROLE_PROMPT_EDITOR)、只读者(ROLE_PROMPT_VIEWER)
- **U14 (普遍性)**: 系统必须支持基于项目的权限隔离（扩展功能），编辑者仅能操作授权项目的提示词
- **S2 (状态驱动)**: 当用户为管理员时，系统必须允许所有操作（包括删除、日志查看）
- **S3 (状态驱动)**: 当用户为编辑者时，系统必须允许创建/编辑/测试，禁止删除和日志查看
- **S4 (状态驱动)**: 当用户为只读者时，系统必须仅允许查看和测试，禁止所有修改操作
- **E2 (事件驱动)**: 当用户尝试无权限操作时，系统必须阻止并返回403错误，同时记录安全日志
- **C2 (条件性)**: 如果启用项目级权限，那么系统必须额外验证用户对特定项目的访问权限

#### 功能性需求 - 数据安全（风险控制）
- **U5 (普遍性)**: 系统必须保证日志数据仅新增，不允许修改/删除（使用数据库约束确保）
- **U6 (普遍性)**: 系统必须支持敏感信息的安全存储（如API Key使用Symfony Secrets）
- **U7 (普遍性)**: 系统必须强制使用HTTPS传输
- **U8 (普遍性)**: 系统必须集成现有Symfony Security体系，避免独立认证系统
- **U15 (普遍性)**: 系统必须支持敏感操作的二次确认（如批量删除）
- **U16 (普遍性)**: 系统必须对频繁操作进行限流保护，防止恶意攻击

#### 非功能性需求（韧性保障）
- **U9 (普遍性)**: 日志记录必须是异步操作，不影响主业务流程性能
- **U10 (普遍性)**: 日志查询响应时间必须<200ms
- **U11 (普遍性)**: 权限验证响应时间必须<50ms
- **U12 (普遍性)**: 系统必须支持日志数据定期备份和归档
- **U17 (普遍性)**: 系统必须支持权限配置的热重载，无需重启服务
- **U18 (普遍性)**: 系统必须具备自监控能力，当权限系统异常时能自动降级到安全模式
- **U19 (普遍性)**: 系统必须支持批量操作的事务性，确保操作的原子性

### 1.3. 验收标准 (Acceptance Criteria)

#### 基础功能验收
- [ ] 所有关键操作都能被正确记录到审计日志（包括IP、User-Agent等完整上下文）
- [ ] 管理员可以查看完整的操作日志并进行多维度筛选
- [ ] 非管理员无法访问日志相关功能
- [ ] 三种角色的权限控制正确生效
- [ ] 无权限用户尝试操作时被正确拦截并记录安全日志
- [ ] 日志数据无法被修改或删除（通过数据库约束保证）
- [ ] 系统继承现有认证体系，无需独立登录
- [ ] 敏感配置信息得到安全保护

#### 韧性与扩展性验收
- [ ] 日志记录失败时有降级方案，不阻塞主业务
- [ ] 权限系统异常时能自动降级到安全模式
- [ ] 支持项目级权限隔离（扩展功能）
- [ ] 支持权限配置热重载，无需重启
- [ ] 支持批量操作的事务原子性
- [ ] 敏感操作（批量删除）需要二次确认

#### 风险控制验收
- [ ] 频繁操作有限流保护
- [ ] 所有安全相关操作都有审计记录
- [ ] 支持按日志级别筛选和监控
- [ ] 日志数据支持定期归档和备份

### 1.4. 业务场景分析（基于原始PRD）

#### 场景1：运营人员日常维护提示词
**背景**：运营/产品经理需要通过可视化界面维护提示词内容
**安全要求**：
- 操作过程完整审计（谁在何时修改了什么内容）
- 权限隔离（不同项目的运营人员只能访问授权内容）
- 敏感提示词的访问控制

#### 场景2：开发者集成调用提示词
**背景**：开发者通过标准化服务接口获取提示词
**安全要求**：
- API调用审计（哪个服务在何时调用了哪个提示词）
- 服务间权限验证
- 敏感提示词的访问日志

#### 场景3：系统管理员合规审查
**背景**：管理员需要查看操作历史，满足合规要求
**安全要求**：
- 完整的操作轨迹追踪
- 不可篡改的审计证据
- 按时间段、用户、操作类型等多维度分析

#### 场景4：异常情况处理
**背景**：权限系统故障或恶意攻击情况
**安全要求**：
- 降级到只读模式，确保数据安全
- 异常情况的完整记录
- 自动报警和恢复机制

### 1.5. 模块协调设计

#### 与prompt-core-management的协调
- **数据一致性**：审计日志与提示词数据的一致性保证
- **操作拦截**：在CRUD操作前后插入权限检查和日志记录
- **接口契约**：定义统一的权限验证接口

#### 与prompt-version-control的协调  
- **版本安全**：版本切换操作的审计记录
- **回滚权限**：不同角色对版本回滚的权限控制
- **版本对比**：敏感内容的访问权限控制

#### 与prompt-testing-system的协调
- **测试权限**：不同角色对测试功能的访问控制
- **测试记录**：测试操作的审计记录（包括测试参数）
- **API对接**：AI API测试的权限控制和使用记录

### 1.6. 风险评估与缓解策略

#### 高风险项
| 风险 | 影响级别 | 缓解策略 |
|---|---|---|
| 权限绕过攻击 | 高 | 多层权限验证 + 操作审计 |
| 日志数据泄露 | 高 | 敏感信息脱敏 + 访问控制 |
| 系统可用性影响 | 中 | 异步处理 + 降级方案 |
| 配置错误导致权限失效 | 高 | 配置验证 + 默认拒绝策略 |

#### 扩展性风险控制
- **复杂度控制**：严格限制权限模型复杂度，避免过度设计
- **性能影响**：权限检查和日志记录的性能开销控制在<10ms
- **运维复杂度**：提供简洁的权限配置界面，避免复杂的权限继承关系

---

## 2️⃣ 技术设计 [状态: ⏸️待开始]

### 2.1. 架构决策
- **架构模式**: **扁平化Service层** (严禁DDD等多层抽象)
- **实体模型**: **贫血模型** (Entity仅包含getter/setter，无业务逻辑)
- **配置管理**: **环境变量 `$_ENV`** (严禁Configuration类和复杂配置加载)
- **框架集成**: Symfony Bundle + Symfony Security + EasyAdminBundle
- **API策略**: **默认不创建API** (除非需求明确要求)

### 2.2. 核心组件与职责
| 组件 | 职责 | 依赖 |
|---|---|---|
| `AuditService` | 审计日志核心业务逻辑 | `AuditLogRepository` |
| `SecurityService` | 权限验证和控制 | `Symfony Security` |
| `AuditLog` | 审计日志数据模型（贫血） | 无 |
| `AuditLogRepository` | 审计日志数据访问 | `Doctrine` |
| `PermissionChecker` | 权限检查器 | `Symfony Security` |

### 2.3. 接口设计
```php
interface AuditServiceInterface 
{
    /**
     * 记录操作日志
     * @param string $operation 操作类型（create/update/delete/switch_version）
     * @param int $promptId 提示词ID
     * @param int|null $versionId 版本ID
     * @param int $userId 操作人ID
     * @param array $metadata 额外信息
     */
    public function logOperation(
        string $operation, 
        int $promptId, 
        ?int $versionId = null, 
        int $userId = 0, 
        array $metadata = []
    ): void;

    /**
     * 获取审计日志列表
     * @param array $filters 筛选条件：['user_id', 'operation', 'date_from', 'date_to']
     */
    public function getAuditLogs(array $filters = []): array;

    /**
     * 获取指定提示词的操作历史
     */
    public function getPromptHistory(int $promptId): array;
}

interface SecurityServiceInterface 
{
    /**
     * 检查用户是否有指定权限
     */
    public function hasPermission(string $permission): bool;

    /**
     * 检查用户是否可以执行指定操作
     */
    public function canPerformOperation(string $operation, ?int $promptId = null): bool;

    /**
     * 获取当前用户角色
     */
    public function getCurrentUserRole(): string;

    /**
     * 验证并抛出权限异常
     */
    public function ensurePermission(string $permission): void;
}

interface PermissionCheckerInterface
{
    /**
     * 检查EasyAdmin页面访问权限
     */
    public function checkPageAccess(string $page, array $context = []): bool;

    /**
     * 检查实体操作权限
     */
    public function checkEntityOperation(string $entity, string $operation): bool;
}
```

### 2.4. ⚠️ 设计质量门禁 (Design Quality Gates)
- [ ] **通过 `.claude/standards/design-checklist.md` 所有检查项?**
- [ ] 遵循扁平化Service架构?
- [ ] Entity是贫血模型?
- [ ] 无Configuration类?
- [ ] 配置通过`$_ENV`读取?
- [ ] 未主动创建HTTP API?

---

## 3️⃣ 任务分解 [状态: ⏸️待开始]

### 3.1. LLM-TDD 任务列表
| ID | 任务名称 | 类型 | 状态 | 预计(h) | 实际(h) | 依赖 |
|---|---|---|---|---|---|---|
| A01 | **规范**: 创建 `AuditLog` Entity | 实体 | `⏸️待开始` | 1 | - | - |
| A02 | **规范**: 创建 `AuditServiceInterface` | 接口 | `⏸️待开始` | 1 | - | - |
| A03 | **规范**: 创建 `SecurityServiceInterface` | 接口 | `⏸️待开始` | 1 | - | - |
| A04 | **规范**: 创建 `PermissionCheckerInterface` | 接口 | `⏸️待开始` | 0.5 | - | - |
| A05 | **实现**: 创建 `AuditLogRepository` | 仓储 | `⏸️待开始` | 2 | - | A01 |
| A06 | **实现**: 创建 `AuditService` 日志记录 | 实现 | `⏸️待开始` | 3 | - | A02,A05 |
| A07 | **实现**: 创建 `SecurityService` 权限控制 | 实现 | `⏸️待开始` | 3 | - | A03 |
| A08 | **实现**: 创建 `PermissionChecker` EasyAdmin集成 | 实现 | `⏸️待开始` | 2 | - | A04,A07 |
| A09 | **实现**: 在其他Service中集成日志记录 | 实现 | `⏸️待开始` | 2 | - | A06 |
| A10 | **实现**: EasyAdmin权限控制集成 | 实现 | `⏸️待开始` | 3 | - | A08 |
| A11 | **测试**: `AuditService` 的单元测试 | 测试 | `⏸️待开始` | 3 | - | A06,A09 |
| A12 | **测试**: `SecurityService` 的单元测试 | 测试 | `⏸️待开始` | 3 | - | A07 |
| A13 | **测试**: `PermissionChecker` 的单元测试 | 测试 | `⏸️待开始` | 2 | - | A08 |
| A14 | **界面**: 审计日志管理界面 | 界面 | `⏸️待开始` | 3 | - | A01 |
| A15 | **界面**: 权限控制界面适配 | 界面 | `⏸️待开始` | 2 | - | A10 |
| A16 | **配置**: Symfony Security配置 | 配置 | `⏸️待开始` | 1.5 | - | - |
| A17 | **质量**: 静态分析与代码规范 | 质量 | `⏸️待开始` | 1 | - | A11-A16 |

**任务状态说明**:
- `⏸️待开始`: 尚未开始
- `🔄进行中`: 正在执行  
- `✅完成`: 已完成并通过验证
- `🔄需返工`: 已完成但验证失败，需要修复
- `🚫已阻塞`: 因依赖问题暂时无法进行

### 3.2. 质量验收标准 (Quality Acceptance Criteria)
- **PHPStan Level**: `8`
- **代码覆盖率 (Package)**: `≥90%`
- **代码覆盖率 (Project)**: `≥80%`
- **代码规范**: `PSR-12` (通过 `php-cs-fixer` 检查)

---

## 4️⃣ 高级分析 (可选) [状态: ⏸️待开始]

### 4.1. 安全威胁建模 (STRIDE)
| 威胁类型 | 风险评估 | 缓解策略 |
|---|---|---|
| **Spoofing** | 高 | 强认证、JWT令牌、会话管理 |
| **Tampering** | 高 | 日志不可修改、数据库约束、HTTPS |
| **Repudiation** | 低 | 完整的操作审计、时间戳记录 |
| **Info. Disclosure** | 高 | 角色权限控制、敏感数据加密 |
| **Denial of Service** | 中 | 操作频率限制、日志存储限制 |
| **Elev. of Privilege** | 高 | 严格的角色权限体系、权限验证 |

### 4.2. 依赖影响分析
- **内部依赖**: prompt-core-management, prompt-version-control, prompt-testing-system（所有功能的权限控制）
- **外部依赖**: Symfony Security, Doctrine ORM, EasyAdminBundle
- **反向依赖**: 无（这是横切关注点，被其他模块依赖）

---

## 5️⃣ 实施记录 [由 /feature-execute 命令自动更新]

---

## 6️⃣ 迭代历史 [由 /feature-validate 命令自动更新]

---

## 7️⃣ 验证报告 [由 /feature-validate 命令自动更新]